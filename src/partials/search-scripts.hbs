{{#if (eq env.SITE_SEARCH_PROVIDER "Typesense")}}
<script src="{{uiRootPath}}/js/vendor/docsearch.min.js"></script>
<script type="module">
  import { AiSearch } from '{{uiRootPath}}/js/vendor/ai-search.js';
  import { SearchMode } from '{{uiRootPath}}/js/vendor/search-mode.js';

  const API_PATH = '/api/search';
  const switchElement = document.getElementById("search-mode-switch");

  const searchMode = new SearchMode(switchElement);
  const aiSearch = new AiSearch(API_PATH);

  const collectionName = '{{env.TYPESENSE_IDX_NAME}}';
  const goToSearchPage = (value) => {
    let hrefUrl = '/search?';
    if (collectionName !== "help") {
      //пример адреса: https://doc-online-vdv.digdes.com/dv5/upgrade/
      //"dv5" - версия сайта
      //добавляем версию сайта в hrefUrl перед '/search?'
      const siteVersion = window.location.pathname.split('/')[1];
      hrefUrl = '/' + siteVersion + '/' + hrefUrl;
    }
    const queryAttribute = searchMode.isAiSearchMode ? '[aiquery]' : '[query]';
    document.location.href = hrefUrl + '{{env.TYPESENSE_IDX_NAME}}' + queryAttribute + '=' + value;
  }
  const searchInput = document.querySelector('#search-input');

  searchInput?.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      goToSearchPage(e.target.value);
    }
  })
  document.querySelector('.header-search-button')?.addEventListener('click', function (e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    goToSearchPage(searchInput.value);
  })

  document.addEventListener('ai-search initialised', () => {
    if (aiSearch.isAvailable) {
      searchMode.showElement();
    }
  })

  let docSearchInstance = initDocsearch();

  searchMode.subscribe((isAiSearchMode) => {
    if (isAiSearchMode) {
      docSearchInstance.autocomplete.autocomplete.destroy()
      return
    }

    docSearchInstance = initDocsearch()
  })

  function initDocsearch() {
    return docsearch({
      inputSelector: '#search-input',
      typesenseCollectionName: '{{env.TYPESENSE_IDX_NAME}}',
      typesenseServerConfig: {
        nodes: [{
          host: window.location.hostname,
          port: '443',
          protocol: 'https'
        }],
        apiKey: '{{env.TYPESENSE_API_KEY}}',
      },
      typesenseSearchParams: {
        per_page: 15,
        infix: 'always',
      },
    });
  }
</script>
{{/if}}
